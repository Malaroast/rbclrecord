<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>야구 기록 열람</title>
  <style>
    :root{
      --primary:#1b4fa1;
      --bg:#f5f6f8;
      --card:#ffffff;
      --border:#e5e7eb;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family: "Pretendard","맑은 고딕",system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;background:var(--bg);color:#111}
    .header{background:var(--primary);color:#fff;padding:16px 20px;font-size:20px;font-weight:700;display:flex;align-items:center;gap:12px}
    .header input{max-width:320px;width:100%;padding:10px 12px;border-radius:10px;border:0;outline:none}

    .container{max-width:1200px;margin:20px auto;padding:0 16px}

    .control-bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .pill{background:#e5efff;color:#0f2f7f;border:1px solid #cfe0ff;padding:8px 12px;border-radius:999px;font-weight:600;cursor:pointer}
    .pill.active{background:#0f2f7f;color:#fff;border-color:#0f2f7f}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .section{padding:16px 16px 4px 16px;color:var(--muted);font-weight:700;text-transform:uppercase;font-size:12px}

    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:center;white-space:nowrap}
    tr:nth-child(even) td{background:#fafafa}
    th.sortable{cursor:pointer;user-select:none}
    th .arrow{font-size:10px;margin-left:4px;color:var(--muted)}

    .hint{color:var(--muted);font-size:13px;margin-top:8px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.open{display:flex}
    .modal-card{background:#fff;border-radius:16px;max-width:760px;width:100%;border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#f8fafc;border-bottom:1px solid var(--border)}
    .modal-title{font-weight:800}
    .close{border:0;background:transparent;font-size:22px;cursor:pointer}
    .modal-body{padding:16px}
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .detail-grid .row{display:flex;justify-content:space-between;padding:8px 10px;border:1px solid var(--border);border-radius:10px}
    .row .k{color:var(--muted)}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;font-size:12px;font-weight:700}

    a.nick{color:var(--primary);text-decoration:none}
    a.nick:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="header">
    <div style="font-size:22px">⚾ 야구 기록 열람</div>
    <input id="searchInput" placeholder="닉네임으로 검색 (예: 홍길동)" onkeydown="if(event.key==='Enter'){searchByNickname()}" />
    <button class="pill" onclick="searchByNickname()">검색</button>
  </div>

  <div class="container">
    <div class="control-bar">
      <button class="pill active" id="tab-batters" onclick="switchTab('batters')">타자</button>
      <button class="pill" id="tab-pitchers" onclick="switchTab('pitchers')">투수</button>
      <div class="hint">헤더를 클릭해서 오름/내림차순 정렬할 수 있어요.</div>
    </div>

    <!-- 타자 테이블 -->
    <div class="card" id="card-batters">
      <div class="section">Batters</div>
      <div class="table-wrap">
        <table id="table-batters"></table>
      </div>
    </div>

    <!-- 투수 테이블 -->
    <div class="card" id="card-pitchers" style="display:none;">
      <div class="section">Pitchers</div>
      <div class="table-wrap">
        <table id="table-pitchers"></table>
      </div>
    </div>
  </div>

  <!-- 상세 모달 -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">선수 세부 기록</div>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1KIW6RJT7knTMGgCEkSeeGr5v5-uB3864Oqzqd7ATu5Y";
    const URL_BATTERS = `https://opensheet.elk.sh/${SHEET_ID}/Batters`;
    const URL_PITCHERS = `https://opensheet.elk.sh/${SHEET_ID}/Pitchers`;

    let batters = [], pitchers = [];
    let state = {
      tab: 'batters',
      sort: { batters: { key: null, dir: 1 }, pitchers: { key: null, dir: 1 } },
      nicknameKey: { batters: null, pitchers: null }
    };

    // 유틸: 닉네임/이름 컬럼 키 탐색
    function detectNicknameKey(obj){
      const candidates = ['닉네임','Nickname','nick','name','이름','Player','선수명'];
      return candidates.find(k => k in obj) || Object.keys(obj)[0];
    }

    // 표 렌더링
    function renderTable(data, tableId, type){
      const table = document.getElementById(tableId);
      if(!data || data.length === 0){ table.innerHTML = '<thead><tr><th>데이터가 없습니다</th></tr></thead>'; return; }

      // 헤더
      const keys = Object.keys(data[0]);
      const thead = `<thead><tr>
        ${keys.map(k=>`<th class="sortable" onclick="sortBy('${type}','${k}')">${k}<span class="arrow">${arrowFor(type,k)}</span></th>`).join('')}
      </tr></thead>`;

      // 행
      const nicknameKey = state.nicknameKey[type] || (state.nicknameKey[type] = detectNicknameKey(data[0]));
      const tbody = `<tbody>
        ${data.map(row=>{
          return `<tr>${keys.map(k=>{
            if(k===nicknameKey){
              return `<td><a href="#" class="nick" onclick="openDetail('${type}', '${escapeHtml(String(row[k]))}')">${escapeHtml(String(row[k]))}</a></td>`
            }
            return `<td>${escapeHtml(String(row[k]))}</td>`;
          }).join('')}</tr>`;
        }).join('')}
      </tbody>`;

      table.innerHTML = thead + tbody;
    }

    function arrowFor(type,key){
      const s = state.sort[type];
      if(s.key!==key) return '';
      return s.dir>0 ? ' ▲' : ' ▼';
    }

    function sortBy(type, key){
      const s = state.sort[type];
      if(s.key === key){ s.dir *= -1; } else { s.key = key; s.dir = 1; }
      const data = (type==='batters'? batters: pitchers).slice();
      data.sort((a,b)=>{
        const A = coerce(a[key]);
        const B = coerce(b[key]);
        if(A < B) return -1*s.dir;
        if(A > B) return 1*s.dir;
        return 0;
      });
      if(type==='batters'){ batters = data; renderTable(batters,'table-batters','batters'); }
      else { pitchers = data; renderTable(pitchers,'table-pitchers','pitchers'); }
    }

    function coerce(v){
      // 숫자처럼 보이면 숫자로 비교, 아니면 문자열 소문자 비교
      const num = parseFloat(String(v).replace(/[%,]/g,''));
      if(!isNaN(num) && String(v).trim()!=='' ) return num;
      return String(v).toLowerCase();
    }

    function switchTab(tab){
      state.tab = tab;
      document.getElementById('tab-batters').classList.toggle('active', tab==='batters');
      document.getElementById('tab-pitchers').classList.toggle('active', tab==='pitchers');
      document.getElementById('card-batters').style.display = tab==='batters'? 'block':'none';
      document.getElementById('card-pitchers').style.display = tab==='pitchers'? 'block':'none';
    }

    function searchByNickname(){
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if(!q) return;
      const inBatters = batters.find(r=> String(r[state.nicknameKey.batters||detectNicknameKey(r)]).toLowerCase()===q);
      const inPitchers = pitchers.find(r=> String(r[state.nicknameKey.pitchers||detectNicknameKey(r)]).toLowerCase()===q);
      if(inBatters){ switchTab('batters'); openDetail('batters', String(inBatters[state.nicknameKey.batters||detectNicknameKey(inBatters)])); return; }
      if(inPitchers){ switchTab('pitchers'); openDetail('pitchers', String(inPitchers[state.nicknameKey.pitchers||detectNicknameKey(inPitchers)])); return; }
      // 부분 일치로 재탐색
      const pb = batters.filter(r=> String(r[state.nicknameKey.batters||detectNicknameKey(r)]).toLowerCase().includes(q));
      const pp = pitchers.filter(r=> String(r[state.nicknameKey.pitchers||detectNicknameKey(r)]).toLowerCase().includes(q));
      if(pb.length){ switchTab('batters'); openSelectList('batters', pb); return; }
      if(pp.length){ switchTab('pitchers'); openSelectList('pitchers', pp); return; }
      alert('선수를 찾을 수 없습니다. 철자 또는 띄어쓰기를 확인해 주세요.');
    }

    function openSelectList(type, list){
      const nicknameKey = state.nicknameKey[type] || detectNicknameKey(list[0]);
      document.getElementById('modalTitle').textContent = '선수 선택';
      const html = `
        <div class="hint" style="margin-bottom:8px">여러 명이 검색되었습니다. 열람할 선수를 선택하세요.</div>
        <div class="detail-grid">
          ${list.map(r=>`<div class="row"><span class="k">닉네임</span><a class="nick" href="#" onclick="openDetail('${type}','${escapeHtml(String(r[nicknameKey]))}')">${escapeHtml(String(r[nicknameKey]))}</a></div>`).join('')}
        </div>`;
      document.getElementById('modalBody').innerHTML = html;
      openModal();
    }

    function openDetail(type, nickname){
      const data = (type==='batters'? batters: pitchers);
      const nicknameKey = state.nicknameKey[type] || detectNicknameKey(data[0]||{});
      const row = data.find(r=> String(r[nicknameKey]) === String(nickname));
      if(!row){ alert('기록을 찾지 못했습니다.'); return; }
      document.getElementById('modalTitle').innerHTML = `${escapeHtml(String(row[nicknameKey]))} <span class="badge">${type==='batters'?'타자':'투수'}</span>`;
      const keys = Object.keys(row);
      const grid = keys.map(k=>`<div class="row"><span class="k">${escapeHtml(k)}</span><span>${escapeHtml(String(row[k]))}</span></div>`).join('');
      document.getElementById('modalBody').innerHTML = `<div class="detail-grid">${grid}</div>`;
      openModal();
    }

    function openModal(){ document.getElementById('modal').classList.add('open'); }
    function closeModal(){ document.getElementById('modal').classList.remove('open'); }
    document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });

    function escapeHtml(str){
      return str
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    async function init(){
      try{
        const [b,p] = await Promise.all([
          fetch(URL_BATTERS).then(r=>r.json()),
          fetch(URL_PITCHERS).then(r=>r.json())
        ]);
        batters = b; pitchers = p;
        // 초기 렌더
        renderTable(batters,'table-batters','batters');
        renderTable(pitchers,'table-pitchers','pitchers');
      }catch(err){
        console.error(err);
        alert('스프레드시트 데이터를 불러오는 중 오류가 발생했습니다. 공개 설정과 시트 이름(Batters, Pitchers)을 확인해 주세요.');
      }
    }

    init();
  </script>
</body>
</html>
